<html>
<head>
<title>deprecations.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5d69bb;}
.s1 { color: #d8d8d8;}
.s2 { color: #717ed3; font-style: italic;}
.s3 { color: #cc8b60;}
.s4 { color: #96bf7d;}
.s5 { color: #cc7832;}
.s6 { color: #bbb55b;}
</style>
</head>
<body bgcolor="#1a1a25">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
deprecations.py</font>
</center></td></tr></table>
<pre><span class="s0"># util/deprecations.py</span>
<span class="s0"># Copyright (C) 2005-2024 the SQLAlchemy authors and contributors</span>
<span class="s0"># &lt;see AUTHORS file&gt;</span>
<span class="s0">#</span>
<span class="s0"># This module is part of SQLAlchemy and is released under</span>
<span class="s0"># the MIT License: https://www.opensource.org/licenses/mit-license.php</span>
<span class="s0"># mypy: allow-untyped-defs, allow-untyped-calls</span>

<span class="s2">&quot;&quot;&quot;Helpers related to deprecation of functions, methods, classes, other 
functionality.&quot;&quot;&quot;</span>

<span class="s3">from </span><span class="s1">__future__ </span><span class="s3">import </span><span class="s1">annotations</span>

<span class="s3">import </span><span class="s1">re</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Any</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Callable</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Dict</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Match</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Optional</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Sequence</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Set</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Tuple</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Type</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">TypeVar</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Union</span>

<span class="s3">from </span><span class="s1">. </span><span class="s3">import </span><span class="s1">compat</span>
<span class="s3">from </span><span class="s1">.langhelpers </span><span class="s3">import </span><span class="s1">_hash_limit_string</span>
<span class="s3">from </span><span class="s1">.langhelpers </span><span class="s3">import </span><span class="s1">_warnings_warn</span>
<span class="s3">from </span><span class="s1">.langhelpers </span><span class="s3">import </span><span class="s1">decorator</span>
<span class="s3">from </span><span class="s1">.langhelpers </span><span class="s3">import </span><span class="s1">inject_docstring_text</span>
<span class="s3">from </span><span class="s1">.langhelpers </span><span class="s3">import </span><span class="s1">inject_param_text</span>
<span class="s3">from </span><span class="s1">.. </span><span class="s3">import </span><span class="s1">exc</span>

<span class="s1">_T = TypeVar(</span><span class="s4">&quot;_T&quot;</span><span class="s5">, </span><span class="s1">bound=Any)</span>


<span class="s0"># https://mypy.readthedocs.io/en/stable/generics.html#declaring-decorators</span>
<span class="s1">_F = TypeVar(</span><span class="s4">&quot;_F&quot;</span><span class="s5">, </span><span class="s1">bound=</span><span class="s4">&quot;Callable[..., Any]&quot;</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">_warn_with_version(</span>
    <span class="s1">msg: str</span><span class="s5">,</span>
    <span class="s1">version: str</span><span class="s5">,</span>
    <span class="s1">type_: Type[exc.SADeprecationWarning]</span><span class="s5">,</span>
    <span class="s1">stacklevel: int</span><span class="s5">,</span>
    <span class="s1">code: Optional[str] = </span><span class="s3">None</span><span class="s5">,</span>
<span class="s1">) -&gt; </span><span class="s3">None</span><span class="s1">:</span>
    <span class="s1">warn = type_(msg</span><span class="s5">, </span><span class="s1">code=code)</span>
    <span class="s1">warn.deprecated_since = version</span>

    <span class="s1">_warnings_warn(warn</span><span class="s5">, </span><span class="s1">stacklevel=stacklevel + </span><span class="s6">1</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">warn_deprecated(</span>
    <span class="s1">msg: str</span><span class="s5">, </span><span class="s1">version: str</span><span class="s5">, </span><span class="s1">stacklevel: int = </span><span class="s6">3</span><span class="s5">, </span><span class="s1">code: Optional[str] = </span><span class="s3">None</span>
<span class="s1">) -&gt; </span><span class="s3">None</span><span class="s1">:</span>
    <span class="s1">_warn_with_version(</span>
        <span class="s1">msg</span><span class="s5">, </span><span class="s1">version</span><span class="s5">, </span><span class="s1">exc.SADeprecationWarning</span><span class="s5">, </span><span class="s1">stacklevel</span><span class="s5">, </span><span class="s1">code=code</span>
    <span class="s1">)</span>


<span class="s3">def </span><span class="s1">warn_deprecated_limited(</span>
    <span class="s1">msg: str</span><span class="s5">,</span>
    <span class="s1">args: Sequence[Any]</span><span class="s5">,</span>
    <span class="s1">version: str</span><span class="s5">,</span>
    <span class="s1">stacklevel: int = </span><span class="s6">3</span><span class="s5">,</span>
    <span class="s1">code: Optional[str] = </span><span class="s3">None</span><span class="s5">,</span>
<span class="s1">) -&gt; </span><span class="s3">None</span><span class="s1">:</span>
    <span class="s2">&quot;&quot;&quot;Issue a deprecation warning with a parameterized string, 
    limiting the number of registrations. 
 
    &quot;&quot;&quot;</span>
    <span class="s3">if </span><span class="s1">args:</span>
        <span class="s1">msg = _hash_limit_string(msg</span><span class="s5">, </span><span class="s6">10</span><span class="s5">, </span><span class="s1">args)</span>
    <span class="s1">_warn_with_version(</span>
        <span class="s1">msg</span><span class="s5">, </span><span class="s1">version</span><span class="s5">, </span><span class="s1">exc.SADeprecationWarning</span><span class="s5">, </span><span class="s1">stacklevel</span><span class="s5">, </span><span class="s1">code=code</span>
    <span class="s1">)</span>


<span class="s3">def </span><span class="s1">deprecated_cls(</span>
    <span class="s1">version: str</span><span class="s5">, </span><span class="s1">message: str</span><span class="s5">, </span><span class="s1">constructor: Optional[str] = </span><span class="s4">&quot;__init__&quot;</span>
<span class="s1">) -&gt; Callable[[Type[_T]]</span><span class="s5">, </span><span class="s1">Type[_T]]:</span>
    <span class="s1">header = </span><span class="s4">&quot;.. deprecated:: %s %s&quot; </span><span class="s1">% (version</span><span class="s5">, </span><span class="s1">(message </span><span class="s3">or </span><span class="s4">&quot;&quot;</span><span class="s1">))</span>

    <span class="s3">def </span><span class="s1">decorate(cls: Type[_T]) -&gt; Type[_T]:</span>
        <span class="s3">return </span><span class="s1">_decorate_cls_with_warning(</span>
            <span class="s1">cls</span><span class="s5">,</span>
            <span class="s1">constructor</span><span class="s5">,</span>
            <span class="s1">exc.SADeprecationWarning</span><span class="s5">,</span>
            <span class="s1">message % dict(func=constructor)</span><span class="s5">,</span>
            <span class="s1">version</span><span class="s5">,</span>
            <span class="s1">header</span><span class="s5">,</span>
        <span class="s1">)</span>

    <span class="s3">return </span><span class="s1">decorate</span>


<span class="s3">def </span><span class="s1">deprecated(</span>
    <span class="s1">version: str</span><span class="s5">,</span>
    <span class="s1">message: Optional[str] = </span><span class="s3">None</span><span class="s5">,</span>
    <span class="s1">add_deprecation_to_docstring: bool = </span><span class="s3">True</span><span class="s5">,</span>
    <span class="s1">warning: Optional[Type[exc.SADeprecationWarning]] = </span><span class="s3">None</span><span class="s5">,</span>
    <span class="s1">enable_warnings: bool = </span><span class="s3">True</span><span class="s5">,</span>
<span class="s1">) -&gt; Callable[[_F]</span><span class="s5">, </span><span class="s1">_F]:</span>
    <span class="s2">&quot;&quot;&quot;Decorates a function and issues a deprecation warning on use. 
 
    :param version: 
      Issue version in the warning. 
 
    :param message: 
      If provided, issue message in the warning.  A sensible default 
      is used if not provided. 
 
    :param add_deprecation_to_docstring: 
      Default True.  If False, the wrapped function's __doc__ is left 
      as-is.  If True, the 'message' is prepended to the docs if 
      provided, or sensible default if message is omitted. 
 
    &quot;&quot;&quot;</span>

    <span class="s3">if </span><span class="s1">add_deprecation_to_docstring:</span>
        <span class="s1">header = </span><span class="s4">&quot;.. deprecated:: %s %s&quot; </span><span class="s1">% (</span>
            <span class="s1">version</span><span class="s5">,</span>
            <span class="s1">(message </span><span class="s3">or </span><span class="s4">&quot;&quot;</span><span class="s1">)</span><span class="s5">,</span>
        <span class="s1">)</span>
    <span class="s3">else</span><span class="s1">:</span>
        <span class="s1">header = </span><span class="s3">None</span>

    <span class="s3">if </span><span class="s1">message </span><span class="s3">is None</span><span class="s1">:</span>
        <span class="s1">message = </span><span class="s4">&quot;Call to deprecated function %(func)s&quot;</span>

    <span class="s3">if </span><span class="s1">warning </span><span class="s3">is None</span><span class="s1">:</span>
        <span class="s1">warning = exc.SADeprecationWarning</span>

    <span class="s1">message += </span><span class="s4">&quot; (deprecated since: %s)&quot; </span><span class="s1">% version</span>

    <span class="s3">def </span><span class="s1">decorate(fn: _F) -&gt; _F:</span>
        <span class="s3">assert </span><span class="s1">message </span><span class="s3">is not None</span>
        <span class="s3">assert </span><span class="s1">warning </span><span class="s3">is not None</span>
        <span class="s3">return </span><span class="s1">_decorate_with_warning(</span>
            <span class="s1">fn</span><span class="s5">,</span>
            <span class="s1">warning</span><span class="s5">,</span>
            <span class="s1">message % dict(func=fn.__name__)</span><span class="s5">,</span>
            <span class="s1">version</span><span class="s5">,</span>
            <span class="s1">header</span><span class="s5">,</span>
            <span class="s1">enable_warnings=enable_warnings</span><span class="s5">,</span>
        <span class="s1">)</span>

    <span class="s3">return </span><span class="s1">decorate</span>


<span class="s3">def </span><span class="s1">moved_20(</span>
    <span class="s1">message: str</span><span class="s5">, </span><span class="s1">**kw: Any</span>
<span class="s1">) -&gt; Callable[[Callable[...</span><span class="s5">, </span><span class="s1">_T]]</span><span class="s5">, </span><span class="s1">Callable[...</span><span class="s5">, </span><span class="s1">_T]]:</span>
    <span class="s3">return </span><span class="s1">deprecated(</span>
        <span class="s4">&quot;2.0&quot;</span><span class="s5">, </span><span class="s1">message=message</span><span class="s5">, </span><span class="s1">warning=exc.MovedIn20Warning</span><span class="s5">, </span><span class="s1">**kw</span>
    <span class="s1">)</span>


<span class="s3">def </span><span class="s1">became_legacy_20(</span>
    <span class="s1">api_name: str</span><span class="s5">, </span><span class="s1">alternative: Optional[str] = </span><span class="s3">None</span><span class="s5">, </span><span class="s1">**kw: Any</span>
<span class="s1">) -&gt; Callable[[_F]</span><span class="s5">, </span><span class="s1">_F]:</span>
    <span class="s1">type_reg = re.match(</span><span class="s4">&quot;^:(attr|func|meth):&quot;</span><span class="s5">, </span><span class="s1">api_name)</span>
    <span class="s3">if </span><span class="s1">type_reg:</span>
        <span class="s1">type_ = {</span><span class="s4">&quot;attr&quot;</span><span class="s1">: </span><span class="s4">&quot;attribute&quot;</span><span class="s5">, </span><span class="s4">&quot;func&quot;</span><span class="s1">: </span><span class="s4">&quot;function&quot;</span><span class="s5">, </span><span class="s4">&quot;meth&quot;</span><span class="s1">: </span><span class="s4">&quot;method&quot;</span><span class="s1">}[</span>
            <span class="s1">type_reg.group(</span><span class="s6">1</span><span class="s1">)</span>
        <span class="s1">]</span>
    <span class="s3">else</span><span class="s1">:</span>
        <span class="s1">type_ = </span><span class="s4">&quot;construct&quot;</span>
    <span class="s1">message = (</span>
        <span class="s4">&quot;The %s %s is considered legacy as of the &quot;</span>
        <span class="s4">&quot;1.x series of SQLAlchemy and %s in 2.0.&quot;</span>
        <span class="s1">% (</span>
            <span class="s1">api_name</span><span class="s5">,</span>
            <span class="s1">type_</span><span class="s5">,</span>
            <span class="s4">&quot;becomes a legacy construct&quot;</span><span class="s5">,</span>
        <span class="s1">)</span>
    <span class="s1">)</span>

    <span class="s3">if </span><span class="s4">&quot;:attr:&quot; </span><span class="s3">in </span><span class="s1">api_name:</span>
        <span class="s1">attribute_ok = kw.pop(</span><span class="s4">&quot;warn_on_attribute_access&quot;</span><span class="s5">, </span><span class="s3">False</span><span class="s1">)</span>
        <span class="s3">if not </span><span class="s1">attribute_ok:</span>
            <span class="s3">assert </span><span class="s1">kw.get(</span><span class="s4">&quot;enable_warnings&quot;</span><span class="s1">) </span><span class="s3">is False</span><span class="s5">, </span><span class="s1">(</span>
                <span class="s4">&quot;attribute %s will emit a warning on read access.  &quot;</span>
                <span class="s4">&quot;If you *really* want this, &quot;</span>
                <span class="s4">&quot;add warn_on_attribute_access=True.  Otherwise please add &quot;</span>
                <span class="s4">&quot;enable_warnings=False.&quot; </span><span class="s1">% api_name</span>
            <span class="s1">)</span>

    <span class="s3">if </span><span class="s1">alternative:</span>
        <span class="s1">message += </span><span class="s4">&quot; &quot; </span><span class="s1">+ alternative</span>

    <span class="s1">warning_cls = exc.LegacyAPIWarning</span>

    <span class="s3">return </span><span class="s1">deprecated(</span><span class="s4">&quot;2.0&quot;</span><span class="s5">, </span><span class="s1">message=message</span><span class="s5">, </span><span class="s1">warning=warning_cls</span><span class="s5">, </span><span class="s1">**kw)</span>


<span class="s3">def </span><span class="s1">deprecated_params(**specs: Tuple[str</span><span class="s5">, </span><span class="s1">str]) -&gt; Callable[[_F]</span><span class="s5">, </span><span class="s1">_F]:</span>
    <span class="s2">&quot;&quot;&quot;Decorates a function to warn on use of certain parameters. 
 
    e.g. :: 
 
        @deprecated_params( 
            weak_identity_map=( 
                &quot;0.7&quot;, 
                &quot;the :paramref:`.Session.weak_identity_map parameter &quot; 
                &quot;is deprecated.&quot; 
            ) 
 
        ) 
 
    &quot;&quot;&quot;</span>

    <span class="s1">messages: Dict[str</span><span class="s5">, </span><span class="s1">str] = {}</span>
    <span class="s1">versions: Dict[str</span><span class="s5">, </span><span class="s1">str] = {}</span>
    <span class="s1">version_warnings: Dict[str</span><span class="s5">, </span><span class="s1">Type[exc.SADeprecationWarning]] = {}</span>

    <span class="s3">for </span><span class="s1">param</span><span class="s5">, </span><span class="s1">(version</span><span class="s5">, </span><span class="s1">message) </span><span class="s3">in </span><span class="s1">specs.items():</span>
        <span class="s1">versions[param] = version</span>
        <span class="s1">messages[param] = _sanitize_restructured_text(message)</span>
        <span class="s1">version_warnings[param] = exc.SADeprecationWarning</span>

    <span class="s3">def </span><span class="s1">decorate(fn: _F) -&gt; _F:</span>
        <span class="s1">spec = compat.inspect_getfullargspec(fn)</span>

        <span class="s1">check_defaults: Union[Set[str]</span><span class="s5">, </span><span class="s1">Tuple[()]]</span>
        <span class="s3">if </span><span class="s1">spec.defaults </span><span class="s3">is not None</span><span class="s1">:</span>
            <span class="s1">defaults = dict(</span>
                <span class="s1">zip(</span>
                    <span class="s1">spec.args[(len(spec.args) - len(spec.defaults)) :]</span><span class="s5">,</span>
                    <span class="s1">spec.defaults</span><span class="s5">,</span>
                <span class="s1">)</span>
            <span class="s1">)</span>
            <span class="s1">check_defaults = set(defaults).intersection(messages)</span>
            <span class="s1">check_kw = set(messages).difference(defaults)</span>
        <span class="s3">elif </span><span class="s1">spec.kwonlydefaults </span><span class="s3">is not None</span><span class="s1">:</span>
            <span class="s1">defaults = spec.kwonlydefaults</span>
            <span class="s1">check_defaults = set(defaults).intersection(messages)</span>
            <span class="s1">check_kw = set(messages).difference(defaults)</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">check_defaults = ()</span>
            <span class="s1">check_kw = set(messages)</span>

        <span class="s1">check_any_kw = spec.varkw</span>

        <span class="s0"># latest mypy has opinions here, not sure if they implemented</span>
        <span class="s0"># Concatenate or something</span>
        <span class="s1">@decorator</span>
        <span class="s3">def </span><span class="s1">warned(fn: _F</span><span class="s5">, </span><span class="s1">*args: Any</span><span class="s5">, </span><span class="s1">**kwargs: Any) -&gt; _F:</span>
            <span class="s3">for </span><span class="s1">m </span><span class="s3">in </span><span class="s1">check_defaults:</span>
                <span class="s3">if </span><span class="s1">(defaults[m] </span><span class="s3">is None and </span><span class="s1">kwargs[m] </span><span class="s3">is not None</span><span class="s1">) </span><span class="s3">or </span><span class="s1">(</span>
                    <span class="s1">defaults[m] </span><span class="s3">is not None and </span><span class="s1">kwargs[m] != defaults[m]</span>
                <span class="s1">):</span>
                    <span class="s1">_warn_with_version(</span>
                        <span class="s1">messages[m]</span><span class="s5">,</span>
                        <span class="s1">versions[m]</span><span class="s5">,</span>
                        <span class="s1">version_warnings[m]</span><span class="s5">,</span>
                        <span class="s1">stacklevel=</span><span class="s6">3</span><span class="s5">,</span>
                    <span class="s1">)</span>

            <span class="s3">if </span><span class="s1">check_any_kw </span><span class="s3">in </span><span class="s1">messages </span><span class="s3">and </span><span class="s1">set(kwargs).difference(</span>
                <span class="s1">check_defaults</span>
            <span class="s1">):</span>
                <span class="s3">assert </span><span class="s1">check_any_kw </span><span class="s3">is not None</span>
                <span class="s1">_warn_with_version(</span>
                    <span class="s1">messages[check_any_kw]</span><span class="s5">,</span>
                    <span class="s1">versions[check_any_kw]</span><span class="s5">,</span>
                    <span class="s1">version_warnings[check_any_kw]</span><span class="s5">,</span>
                    <span class="s1">stacklevel=</span><span class="s6">3</span><span class="s5">,</span>
                <span class="s1">)</span>

            <span class="s3">for </span><span class="s1">m </span><span class="s3">in </span><span class="s1">check_kw:</span>
                <span class="s3">if </span><span class="s1">m </span><span class="s3">in </span><span class="s1">kwargs:</span>
                    <span class="s1">_warn_with_version(</span>
                        <span class="s1">messages[m]</span><span class="s5">,</span>
                        <span class="s1">versions[m]</span><span class="s5">,</span>
                        <span class="s1">version_warnings[m]</span><span class="s5">,</span>
                        <span class="s1">stacklevel=</span><span class="s6">3</span><span class="s5">,</span>
                    <span class="s1">)</span>
            <span class="s3">return </span><span class="s1">fn(*args</span><span class="s5">, </span><span class="s1">**kwargs)  </span><span class="s0"># type: ignore[no-any-return]</span>

        <span class="s1">doc = fn.__doc__ </span><span class="s3">is not None and </span><span class="s1">fn.__doc__ </span><span class="s3">or </span><span class="s4">&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">doc:</span>
            <span class="s1">doc = inject_param_text(</span>
                <span class="s1">doc</span><span class="s5">,</span>
                <span class="s1">{</span>
                    <span class="s1">param: </span><span class="s4">&quot;.. deprecated:: %s %s&quot;</span>
                    <span class="s1">% (</span><span class="s4">&quot;1.4&quot; </span><span class="s3">if </span><span class="s1">version == </span><span class="s4">&quot;2.0&quot; </span><span class="s3">else </span><span class="s1">version</span><span class="s5">, </span><span class="s1">(message </span><span class="s3">or </span><span class="s4">&quot;&quot;</span><span class="s1">))</span>
                    <span class="s3">for </span><span class="s1">param</span><span class="s5">, </span><span class="s1">(version</span><span class="s5">, </span><span class="s1">message) </span><span class="s3">in </span><span class="s1">specs.items()</span>
                <span class="s1">}</span><span class="s5">,</span>
            <span class="s1">)</span>
        <span class="s1">decorated = warned(fn)</span>
        <span class="s1">decorated.__doc__ = doc</span>
        <span class="s3">return </span><span class="s1">decorated</span>

    <span class="s3">return </span><span class="s1">decorate</span>


<span class="s3">def </span><span class="s1">_sanitize_restructured_text(text: str) -&gt; str:</span>
    <span class="s3">def </span><span class="s1">repl(m: Match[str]) -&gt; str:</span>
        <span class="s1">type_</span><span class="s5">, </span><span class="s1">name = m.group(</span><span class="s6">1</span><span class="s5">, </span><span class="s6">2</span><span class="s1">)</span>
        <span class="s3">if </span><span class="s1">type_ </span><span class="s3">in </span><span class="s1">(</span><span class="s4">&quot;func&quot;</span><span class="s5">, </span><span class="s4">&quot;meth&quot;</span><span class="s1">):</span>
            <span class="s1">name += </span><span class="s4">&quot;()&quot;</span>
        <span class="s3">return </span><span class="s1">name</span>

    <span class="s1">text = re.sub(</span><span class="s4">r&quot;:ref:`(.+) &lt;.*&gt;`&quot;</span><span class="s5">, </span><span class="s3">lambda </span><span class="s1">m: </span><span class="s4">'&quot;%s&quot;' </span><span class="s1">% m.group(</span><span class="s6">1</span><span class="s1">)</span><span class="s5">, </span><span class="s1">text)</span>
    <span class="s3">return </span><span class="s1">re.sub(</span><span class="s4">r&quot;\:(\w+)\:`~?(?:_\w+)?\.?(.+?)`&quot;</span><span class="s5">, </span><span class="s1">repl</span><span class="s5">, </span><span class="s1">text)</span>


<span class="s3">def </span><span class="s1">_decorate_cls_with_warning(</span>
    <span class="s1">cls: Type[_T]</span><span class="s5">,</span>
    <span class="s1">constructor: Optional[str]</span><span class="s5">,</span>
    <span class="s1">wtype: Type[exc.SADeprecationWarning]</span><span class="s5">,</span>
    <span class="s1">message: str</span><span class="s5">,</span>
    <span class="s1">version: str</span><span class="s5">,</span>
    <span class="s1">docstring_header: Optional[str] = </span><span class="s3">None</span><span class="s5">,</span>
<span class="s1">) -&gt; Type[_T]:</span>
    <span class="s1">doc = cls.__doc__ </span><span class="s3">is not None and </span><span class="s1">cls.__doc__ </span><span class="s3">or </span><span class="s4">&quot;&quot;</span>
    <span class="s3">if </span><span class="s1">docstring_header </span><span class="s3">is not None</span><span class="s1">:</span>
        <span class="s3">if </span><span class="s1">constructor </span><span class="s3">is not None</span><span class="s1">:</span>
            <span class="s1">docstring_header %= dict(func=constructor)</span>

        <span class="s3">if </span><span class="s1">issubclass(wtype</span><span class="s5">, </span><span class="s1">exc.Base20DeprecationWarning):</span>
            <span class="s1">docstring_header += (</span>
                <span class="s4">&quot; (Background on SQLAlchemy 2.0 at: &quot;</span>
                <span class="s4">&quot;:ref:`migration_20_toplevel`)&quot;</span>
            <span class="s1">)</span>
        <span class="s1">doc = inject_docstring_text(doc</span><span class="s5">, </span><span class="s1">docstring_header</span><span class="s5">, </span><span class="s6">1</span><span class="s1">)</span>

        <span class="s1">constructor_fn = </span><span class="s3">None</span>
        <span class="s3">if </span><span class="s1">type(cls) </span><span class="s3">is </span><span class="s1">type:</span>
            <span class="s1">clsdict = dict(cls.__dict__)</span>
            <span class="s1">clsdict[</span><span class="s4">&quot;__doc__&quot;</span><span class="s1">] = doc</span>
            <span class="s1">clsdict.pop(</span><span class="s4">&quot;__dict__&quot;</span><span class="s5">, </span><span class="s3">None</span><span class="s1">)</span>
            <span class="s1">clsdict.pop(</span><span class="s4">&quot;__weakref__&quot;</span><span class="s5">, </span><span class="s3">None</span><span class="s1">)</span>
            <span class="s1">cls = type(cls.__name__</span><span class="s5">, </span><span class="s1">cls.__bases__</span><span class="s5">, </span><span class="s1">clsdict)</span>
            <span class="s3">if </span><span class="s1">constructor </span><span class="s3">is not None</span><span class="s1">:</span>
                <span class="s1">constructor_fn = clsdict[constructor]</span>

        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">cls.__doc__ = doc</span>
            <span class="s3">if </span><span class="s1">constructor </span><span class="s3">is not None</span><span class="s1">:</span>
                <span class="s1">constructor_fn = getattr(cls</span><span class="s5">, </span><span class="s1">constructor)</span>

        <span class="s3">if </span><span class="s1">constructor </span><span class="s3">is not None</span><span class="s1">:</span>
            <span class="s3">assert </span><span class="s1">constructor_fn </span><span class="s3">is not None</span>
            <span class="s3">assert </span><span class="s1">wtype </span><span class="s3">is not None</span>
            <span class="s1">setattr(</span>
                <span class="s1">cls</span><span class="s5">,</span>
                <span class="s1">constructor</span><span class="s5">,</span>
                <span class="s1">_decorate_with_warning(</span>
                    <span class="s1">constructor_fn</span><span class="s5">, </span><span class="s1">wtype</span><span class="s5">, </span><span class="s1">message</span><span class="s5">, </span><span class="s1">version</span><span class="s5">, </span><span class="s3">None</span>
                <span class="s1">)</span><span class="s5">,</span>
            <span class="s1">)</span>
    <span class="s3">return </span><span class="s1">cls</span>


<span class="s3">def </span><span class="s1">_decorate_with_warning(</span>
    <span class="s1">func: _F</span><span class="s5">,</span>
    <span class="s1">wtype: Type[exc.SADeprecationWarning]</span><span class="s5">,</span>
    <span class="s1">message: str</span><span class="s5">,</span>
    <span class="s1">version: str</span><span class="s5">,</span>
    <span class="s1">docstring_header: Optional[str] = </span><span class="s3">None</span><span class="s5">,</span>
    <span class="s1">enable_warnings: bool = </span><span class="s3">True</span><span class="s5">,</span>
<span class="s1">) -&gt; _F:</span>
    <span class="s2">&quot;&quot;&quot;Wrap a function with a warnings.warn and augmented docstring.&quot;&quot;&quot;</span>

    <span class="s1">message = _sanitize_restructured_text(message)</span>

    <span class="s3">if </span><span class="s1">issubclass(wtype</span><span class="s5">, </span><span class="s1">exc.Base20DeprecationWarning):</span>
        <span class="s1">doc_only = (</span>
            <span class="s4">&quot; (Background on SQLAlchemy 2.0 at: &quot;</span>
            <span class="s4">&quot;:ref:`migration_20_toplevel`)&quot;</span>
        <span class="s1">)</span>
    <span class="s3">else</span><span class="s1">:</span>
        <span class="s1">doc_only = </span><span class="s4">&quot;&quot;</span>

    <span class="s1">@decorator</span>
    <span class="s3">def </span><span class="s1">warned(fn: _F</span><span class="s5">, </span><span class="s1">*args: Any</span><span class="s5">, </span><span class="s1">**kwargs: Any) -&gt; _F:</span>
        <span class="s1">skip_warning = </span><span class="s3">not </span><span class="s1">enable_warnings </span><span class="s3">or </span><span class="s1">kwargs.pop(</span>
            <span class="s4">&quot;_sa_skip_warning&quot;</span><span class="s5">, </span><span class="s3">False</span>
        <span class="s1">)</span>
        <span class="s3">if not </span><span class="s1">skip_warning:</span>
            <span class="s1">_warn_with_version(message</span><span class="s5">, </span><span class="s1">version</span><span class="s5">, </span><span class="s1">wtype</span><span class="s5">, </span><span class="s1">stacklevel=</span><span class="s6">3</span><span class="s1">)</span>
        <span class="s3">return </span><span class="s1">fn(*args</span><span class="s5">, </span><span class="s1">**kwargs)  </span><span class="s0"># type: ignore[no-any-return]</span>

    <span class="s1">doc = func.__doc__ </span><span class="s3">is not None and </span><span class="s1">func.__doc__ </span><span class="s3">or </span><span class="s4">&quot;&quot;</span>
    <span class="s3">if </span><span class="s1">docstring_header </span><span class="s3">is not None</span><span class="s1">:</span>
        <span class="s1">docstring_header %= dict(func=func.__name__)</span>

        <span class="s1">docstring_header += doc_only</span>

        <span class="s1">doc = inject_docstring_text(doc</span><span class="s5">, </span><span class="s1">docstring_header</span><span class="s5">, </span><span class="s6">1</span><span class="s1">)</span>

    <span class="s1">decorated = warned(func)</span>
    <span class="s1">decorated.__doc__ = doc</span>
    <span class="s1">decorated._sa_warn = </span><span class="s3">lambda</span><span class="s1">: _warn_with_version(  </span><span class="s0"># type: ignore</span>
        <span class="s1">message</span><span class="s5">, </span><span class="s1">version</span><span class="s5">, </span><span class="s1">wtype</span><span class="s5">, </span><span class="s1">stacklevel=</span><span class="s6">3</span>
    <span class="s1">)</span>
    <span class="s3">return </span><span class="s1">decorated</span>
</pre>
</body>
</html>