<html>
<head>
<title>util.pyx</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5d69bb;}
.s1 { color: #d8d8d8;}
.s2 { color: #cc8b60;}
.s3 { color: #cc7832;}
.s4 { color: #bbb55b;}
.s5 { color: #96bf7d;}
.s6 { color: #d7539b; font-weight: bold;}
</style>
</head>
<body bgcolor="#1a1a25">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
util.pyx</font>
</center></td></tr></table>
<pre><span class="s0"># cyextension/util.pyx</span>
<span class="s0"># Copyright (C) 2005-2024 the SQLAlchemy authors and contributors</span>
<span class="s0"># &lt;see AUTHORS file&gt;</span>
<span class="s0">#</span>
<span class="s0"># This module is part of SQLAlchemy and is released under</span>
<span class="s0"># the MIT License: https://www.opensource.org/licenses/mit-license.php</span>
<span class="s2">from </span><span class="s1">collections.abc </span><span class="s2">import </span><span class="s1">Mapping</span>

<span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s1">exc</span>

<span class="s2">cdef </span><span class="s1">tuple _Empty_Tuple = ()</span>

<span class="s2">cdef </span><span class="s1">inline bint _mapping_or_tuple(object value):</span>
    <span class="s2">return </span><span class="s1">isinstance(value</span><span class="s3">, </span><span class="s1">dict) </span><span class="s2">or </span><span class="s1">isinstance(value</span><span class="s3">, </span><span class="s1">tuple) </span><span class="s2">or </span><span class="s1">isinstance(value</span><span class="s3">, </span><span class="s1">Mapping)</span>

<span class="s2">cdef </span><span class="s1">inline bint _check_item(object params) </span><span class="s2">except </span><span class="s4">0</span><span class="s1">:</span>
    <span class="s2">cdef </span><span class="s1">object item</span>
    <span class="s2">cdef </span><span class="s1">bint ret = </span><span class="s4">1</span>
    <span class="s2">if </span><span class="s1">params:</span>
        <span class="s1">item = params[</span><span class="s4">0</span><span class="s1">]</span>
        <span class="s2">if not </span><span class="s1">_mapping_or_tuple(item):</span>
            <span class="s1">ret = </span><span class="s4">0</span>
            <span class="s2">raise </span><span class="s1">exc.ArgumentError(</span>
                <span class="s5">&quot;List argument must consist only of tuples or dictionaries&quot;</span>
            <span class="s1">)</span>
    <span class="s2">return </span><span class="s1">ret</span>

<span class="s2">def </span><span class="s1">_distill_params_20(object params):</span>
    <span class="s2">if </span><span class="s1">params </span><span class="s2">is None</span><span class="s1">:</span>
        <span class="s2">return </span><span class="s1">_Empty_Tuple</span>
    <span class="s2">elif </span><span class="s1">isinstance(params</span><span class="s3">, </span><span class="s1">list) </span><span class="s2">or </span><span class="s1">isinstance(params</span><span class="s3">, </span><span class="s1">tuple):</span>
        <span class="s1">_check_item(params)</span>
        <span class="s2">return </span><span class="s1">params</span>
    <span class="s2">elif </span><span class="s1">isinstance(params</span><span class="s3">, </span><span class="s1">dict) </span><span class="s2">or </span><span class="s1">isinstance(params</span><span class="s3">, </span><span class="s1">Mapping):</span>
        <span class="s2">return </span><span class="s1">[params]</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s2">raise </span><span class="s1">exc.ArgumentError(</span><span class="s5">&quot;mapping or list expected for parameters&quot;</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">_distill_raw_params(object params):</span>
    <span class="s2">if </span><span class="s1">params </span><span class="s2">is None</span><span class="s1">:</span>
        <span class="s2">return </span><span class="s1">_Empty_Tuple</span>
    <span class="s2">elif </span><span class="s1">isinstance(params</span><span class="s3">, </span><span class="s1">list):</span>
        <span class="s1">_check_item(params)</span>
        <span class="s2">return </span><span class="s1">params</span>
    <span class="s2">elif </span><span class="s1">_mapping_or_tuple(params):</span>
        <span class="s2">return </span><span class="s1">[params]</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s2">raise </span><span class="s1">exc.ArgumentError(</span><span class="s5">&quot;mapping or sequence expected for parameters&quot;</span><span class="s1">)</span>

<span class="s2">cdef class </span><span class="s1">prefix_anon_map(dict):</span>
    <span class="s2">def </span><span class="s1">__missing__(self</span><span class="s3">, </span><span class="s1">str key):</span>
        <span class="s2">cdef </span><span class="s1">str derived</span>
        <span class="s2">cdef </span><span class="s1">int anonymous_counter</span>
        <span class="s2">cdef </span><span class="s1">dict self_dict = self</span>

        <span class="s1">derived = key.split(</span><span class="s5">&quot; &quot;</span><span class="s3">, </span><span class="s4">1</span><span class="s1">)[</span><span class="s4">1</span><span class="s1">]</span>

        <span class="s1">anonymous_counter = self_dict.get(derived</span><span class="s3">, </span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">self_dict[derived] = anonymous_counter + </span><span class="s4">1</span>
        <span class="s1">value = </span><span class="s5">f&quot;</span><span class="s6">{</span><span class="s1">derived</span><span class="s6">}</span><span class="s5">_</span><span class="s6">{</span><span class="s1">anonymous_counter</span><span class="s6">}</span><span class="s5">&quot;</span>
        <span class="s1">self_dict[key] = value</span>
        <span class="s2">return </span><span class="s1">value</span>


<span class="s2">cdef class </span><span class="s1">cache_anon_map(dict):</span>
    <span class="s2">cdef </span><span class="s1">int _index</span>

    <span class="s2">def </span><span class="s1">__init__(self):</span>
        <span class="s1">self._index = </span><span class="s4">0</span>

    <span class="s2">def </span><span class="s1">get_anon(self</span><span class="s3">, </span><span class="s1">obj):</span>
        <span class="s2">cdef </span><span class="s1">long long idself</span>
        <span class="s2">cdef </span><span class="s1">str id_</span>
        <span class="s2">cdef </span><span class="s1">dict self_dict = self</span>

        <span class="s1">idself = id(obj)</span>
        <span class="s2">if </span><span class="s1">idself </span><span class="s2">in </span><span class="s1">self_dict:</span>
            <span class="s2">return </span><span class="s1">self_dict[idself]</span><span class="s3">, </span><span class="s2">True</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">id_ = self.__missing__(idself)</span>
            <span class="s2">return </span><span class="s1">id_</span><span class="s3">, </span><span class="s2">False</span>

    <span class="s2">def </span><span class="s1">__missing__(self</span><span class="s3">, </span><span class="s1">key):</span>
        <span class="s2">cdef </span><span class="s1">str val</span>
        <span class="s2">cdef </span><span class="s1">dict self_dict = self</span>

        <span class="s1">self_dict[key] = val = str(self._index)</span>
        <span class="s1">self._index += </span><span class="s4">1</span>
        <span class="s2">return </span><span class="s1">val</span>

</pre>
</body>
</html>